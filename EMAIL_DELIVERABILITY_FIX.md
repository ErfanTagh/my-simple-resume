# Email Deliverability Fix Guide

## Issues Found on Server

1. **No DKIM Record** - Critical for email authentication
2. **SPF uses `~all`** - Should use `-all` for better security
3. **DMARC policy is `p=none`** - No enforcement policy
4. **Using local Postfix** - No DKIM signing configured
5. **FROM email mismatch** - `hello@123resume.de` doesn't match authenticated email

## Current Configuration

```
EMAIL_HOST=172.18.0.1 (local Docker network)
EMAIL_PORT=25 (unauthenticated SMTP)
EMAIL_USE_TLS=False
EMAIL_HOST_USER= (empty)
EMAIL_HOST_PASSWORD= (empty)
DEFAULT_FROM_EMAIL=hello@123resume.de
```

## DNS Records Found

- **SPF**: `v=spf1 ip4:37.27.31.223 ~all` (should be `-all`)
- **DMARC**: `v=DMARC1; p=none; rua=mailto:registration@123resume.de` (should be `p=quarantine` or `p=reject`)
- **DKIM**: **MISSING** ❌

## Solutions

### Option 1: Use Gmail SMTP (Recommended for Quick Fix)

1. Create a Gmail App Password:

   - Go to Google Account → Security → 2-Step Verification → App Passwords
   - Generate an app password for "Mail"

2. Update `.env` file:

```bash
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_USE_SSL=False
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password-here
DEFAULT_FROM_EMAIL=your-email@gmail.com
```

3. Update SPF record to include Gmail:

```
v=spf1 include:_spf.google.com ip4:37.27.31.223 -all
```

### Option 2: Use Professional Email Service (Recommended for Production)

**SendGrid** (Free tier: 100 emails/day):

```bash
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=apikey
EMAIL_HOST_PASSWORD=your-sendgrid-api-key
DEFAULT_FROM_EMAIL=hello@123resume.de
```

**Mailgun** (Free tier: 5,000 emails/month):

```bash
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.mailgun.org
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=postmaster@mg.123resume.de
EMAIL_HOST_PASSWORD=your-mailgun-password
DEFAULT_FROM_EMAIL=hello@123resume.de
```

### Option 3: Configure Postfix with DKIM (Complex but better for custom domain)

1. Install and configure OpenDKIM
2. Generate DKIM keys
3. Add DKIM DNS record
4. Configure Postfix to sign emails

## Immediate Actions Required

### 1. Fix DNS Records

**SPF Record** (Update in your DNS provider):

```
Type: TXT
Name: @ (or 123resume.de)
Value: v=spf1 ip4:37.27.31.223 -all
```

**DMARC Record** (Update):

```
Type: TXT
Name: _dmarc
Value: v=DMARC1; p=quarantine; rua=mailto:registration@123resume.de; ruf=mailto:registration@123resume.de; pct=100
```

**DKIM Record** (Add - requires OpenDKIM setup):

```
Type: TXT
Name: default._domainkey
Value: (will be generated by OpenDKIM)
```

### 2. Update Email Configuration

Choose one of the options above and update your `.env` file.

### 3. Restart Services

```bash
cd /root/my-simple-resume
docker compose restart backend
```

### 4. Test Email Delivery

Use tools like:

- https://www.mail-tester.com/ (send test email, get score)
- https://mxtoolbox.com/ (check DNS records)
- https://www.dmarcanalyzer.com/ (check DMARC)

## Code Improvements Already Made

The email sending code has been improved with:

- Proper email headers (Message-ID, List-Unsubscribe)
- Better HTML email structure
- Improved text/HTML balance
- Professional email templates

## Verification Checklist

- [ ] SPF record updated to `-all`
- [ ] DMARC policy set to `quarantine` or `reject`
- [ ] DKIM record added (if using custom domain)
- [ ] Email service configured (Gmail/SendGrid/Mailgun)
- [ ] `.env` file updated with correct credentials
- [ ] Backend restarted
- [ ] Test email sent and checked with mail-tester.com
- [ ] Score above 8/10 on mail-tester

## Long-term Recommendations

1. **Use a professional email service** (SendGrid/Mailgun) for better deliverability
2. **Set up SPF, DKIM, and DMARC** properly
3. **Monitor email reputation** using services like:
   - Google Postmaster Tools
   - Microsoft SNDS
4. **Warm up your domain** if sending high volumes
5. **Use dedicated IP** for high-volume sending
6. **Monitor bounce rates** and handle them properly
